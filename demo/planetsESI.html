<!DOCTYPE html>
<html>
<head lang="en">
    <title>Planets ESI Demo</title>

    <link rel="stylesheet" href="demos.css">
    <script type="text/javascript" src="../dist/ccpwgl2_int.js"></script>
    <script type="text/javascript" src="../dist/ccpwgl.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="demos.js"></script>

    <script type="text/javascript">

        let canvas, camera, scene, planets = [];

        async function OnDocLoad()
        {
            const {mat4} = tw2.math;

            ccpwgl.initialize("mainCanvas", demos.options);
            camera = ccpwgl.createCamera();
            scene = ccpwgl.loadScene('res:/dx9/scene/universe/g01_cube.red');

            const
                getMoon = ccpwgl.esi.getGraphicDataFromMoonID,
                getPlanet = ccpwgl.esi.getGraphicDataFromPlanetID,
                planetsData = await Promise.all([
                    getPlanet(40000002),
                    getPlanet(40000005),
                    getPlanet(40000007),
                    getPlanet(40000008),
                    getPlanet(40000024),
                    getPlanet(40000011),
                    getMoon(40000010),
                    getPlanet(40000100),
                    getMoon(40000004),
                    getPlanet(40000123)
                ]),
                planetCount = planetsData.length;

            let maxRadius = 0;
            planetsData.forEach(p =>
            {
                p.radius /= 1000;
                maxRadius = Math.max(maxRadius, p.radius * 3)
            });

            for (let i = 0; i < planetCount; i++)
            {
                const {id, name, path, heightMap1, heightMap2, radius} = planetsData[i];

                const planet = scene.loadPlanet(id, path, undefined, heightMap1, heightMap2, function()
                {
                    const angle = Math.PI * 2 * i / planetCount;
                    planet.setTransform(mat4.fromValues(
                        radius, 0, 0, 0,
                        0, radius, 0, 0,
                        0, 0, radius, 0,
                        maxRadius * Math.cos(angle), 0, maxRadius * Math.sin(angle), 1
                    ));
                    console.log(`Loaded ${name}`);
                });
                planets.push(planet);
            }

            ccpwgl.on("pre_render", () =>
            {
                document.getElementById('loading').style.display = ccpwgl.isLoading() ? 'block' : 'none';
            });

        }
    </script>

</head>
<body onload="OnDocLoad()">
<canvas id="mainCanvas" width="500" height="500"></canvas>
<div id="loading">Loading...</div>
</body>
</html>
